---
layout: post
title: "csrf原理"
data: 2019-04-11
tags: [security， web_security]
excerpt: "CSRF & SSRF"
comments: false
share: false
---

## CSRF原理

1. 什么是CSRF漏洞

    Cross site request forgery,跨站请求伪造,是一种服务端请求伪造，攻击者可以构造由服务端发起秦秋的安全漏洞

    利用用户已登录的身份，在用户不知情的情况下以用户的名义完成非法操作,在没有用户权限的情况下实现用户操作

    攻击对象是WEB应用的用户请求，如带参数的GET，一般表单的POST

2. CSRF漏洞的危害

    执行恶意操作

    配合存储型XSS制造网络蠕虫

3. CSRF攻击过程，原理

    用户登录账户

    用户访问攻击者设计好的页面

    攻击者在页面对用户进行了非法操作

    攻击页面由表单和一段javascript代码组成

    例子的形式是：

    用户加载页面，触发onload，执行一段JavaScript代码，在这段代码里面提交一个表单

    这个表单里面，地址是转账的地址，表单的参数是真实转账页面的参数

    这样就完成了利用用户已登陆的身份去完成非法操作

    可以搭配iframe，提高攻击的隐秘性，使用iframe，用户只看到外层的情况，而看不到内层跳转的情况

4. CSRF的攻击条件

    - 用户处于登录状态

    - 伪造的链接与正常应用请求链接一直

    - 后台未对用户业务展开合法性检测

5. 防护手段

    造成CSRF的很大一部分原因是没有对用户的提交的业务进行足够的合法性检测

    防护的关键是确认提交请求的是用户本身

    常见的保护手段是

    - 添加中间环节 - 添加验证过程

        在提交请求之后，服务端不立即接收请求，而是返回一个确认信息，让用户进行进一步的确认，如弹框确认提交信息

        由于攻击者无法获得服务端返回的确认信息，所以可以达到防护效果

        如果这里的验证是使用js实现，则可以绕过

    - 添加中间环节 - 添加验证码

        验证码可以进一步确认提交请求的就是用户本身

    - 验证用户请求合法性-验证refer

        即验证请求来源，思路是，攻击者构造的页面和正常用户所处的页面不同，因此可以通过验证请求来源以进行防护

        refer可以被绕过，不是防护的最佳手段

    - 验证用户请求合法性 - 验证token

        token要符合一次性和随机性的原则

        token是WEB应用唯一识别当前用户的手段，实现思路是，当用户登录成功之后（或者在某个节点），服务端针对当前用户生成一个唯一的、一次性的token，每当客户端发起请求，就把这个token发送给服务端用以验证用户当前身份

        防护思路是，由于攻击者无法获取当前用户的token值，所以即使攻击者成功发送了伪造请求，也达不到效果。


## SSRF原理

1. 什么是SSRF？

    SSRF是伪造服务端发起内容，这个漏洞存在于目标服务器向其他第三方的服务器发起请求的情况

    正常的业务流程：

    - 用户提交参数

    - 服务器接收参数，根据参数，向第三方服务器发起请求，获取相应信息

    - 服务器返回获取的信息

    可以被利用的地方是，服务端没有接收到的参数进行检验、过滤，攻击者可以构造恶意参数（内容），让目标服务器发起请求，最后获取信息。由于是服务器发起的请求，通过这种方法可以获取到攻击者无法获取的到信息。由于存在信息的回显，攻击者提交各种url对内网进行探测。

    从上面可以看到，SSRF的攻击条件是：

    - 服务端具有主动发起请求的功能

    - 服务端没有对用户输入的参数进行过滤和检测

    - 服务端对获取到的信息有回显

    常见的攻击目标是：

    - 图片加载、远程下载

    - 本地处理

        如获取提交的url中的heder等信息

    - 图片、文章收藏功能

2. 防护手段

    一般的防护手段是利用各种黑名单、白名单、正则表达式对用户输入参数进行过滤

